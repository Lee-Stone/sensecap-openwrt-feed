#!/bin/sh
while true; do
    if [ -f /tmp/firmware.img.tar.gz ] && [ ! -f /tmp/firmware.img.tar.gz.progress ]; then
        # Download completed
        echo '{"status":"complete","progress":"100%"}' > /www/ota-progress.json
    elif [ -f /tmp/firmware.img.tar.gz.progress ]; then
        # Check if download failed or cancelled
        if grep -q "Download failed!" /tmp/firmware.img.tar.gz.progress; then
            echo '{"status":"failed","progress":"0%"}' > /www/ota-progress.json
        elif grep -q "Canceled!" /tmp/firmware.img.tar.gz.progress; then
            echo '{"status":"cancelled","progress":"0%"}' > /www/ota-progress.json
        else
            # Extract progress percentage
            progress=$(cat /tmp/firmware.img.tar.gz.progress | tr '\r' '\n' | tail -n1 | grep -o '[0-9]\+\.[0-9]\+%' | tail -1)
            if [ -n "$progress" ]; then
                echo "{\"status\":\"downloading\",\"progress\":\"$progress\"}" > /www/ota-progress.json
            else
                echo '{"status":"downloading","progress":"0%"}' > /www/ota-progress.json
            fi
        fi
    else
        echo '{"status":"idle","progress":"0%"}' > /www/ota-progress.json
    fi
    sleep 1
done
